version: 2.1
parameters:
    repo:
        type: string
        default: rsksmart/rskj
    tag:
        type: string
        default: IRIS-3

commands:
    prepare:
        description: Prepare enveloping and rskj apps
        steps:
            - checkout
            - setup_remote_docker
            - run:
                  name: Install Docker Compose
                  environment:
                      COMPOSE_VERSION: 1.29.2
                  command: |
                      curl -L "https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o ~/docker-compose
                      chmod +x ~/docker-compose
                      sudo mv ~/docker-compose /usr/local/bin/docker-compose

    prepare-container:
        description: 'Preparing Rif Relay Container'
        steps:
            - checkout # special step to check out source code to working directory
            - restore_cache: # special step to restore the dependency cache
                  key: dependency-cachev7-{{ checksum "package.json" }}-npm
            - run:
                  name: Installing Rif Relay
                  command: npm install

    pre-checks:
        description: 'Execute build and code style checks'
        steps:
            - run:
                  name: Build
                  command: npm run build
            - run:
                  name: Linter
                  command: npm run lint
            - run:
                  name: Prettier
                  command: npm run prettier

    run_rskj_node:
        description: Create network and Run RSKJ Container Image on Remote Docker
        steps:
            - run:
                  name: Run RSKJ Container Image
                  command: |
                      docker network create rif-relay-testing
                      docker create -v /cfg --name files node:14.15 /bin/true
                      docker cp $PWD files:/cfg
                      docker-compose up -d
                      docker run --rm --network rif-relay-testing jwilder/dockerize -wait tcp://rsk-node:4444 -timeout 1m
                      docker run --volumes-from files --network rif-relay-testing -w /cfg/project node:14.15 echo $PWD

    run_rskj_test:
        description: Execute the parameter test against RSKj node
        parameters:
            test:
                type: string
        steps:
            - run:
                  name: Execute << parameters.test >>
                  command: |
                      docker run --volumes-from files \
                          --network rif-relay-testing -w /cfg/project node:14.15 \
                          npx truffle test --network rskdocker << parameters.test >>

jobs:
    CodeStyle Checks:
        docker:
            - image: 'cimg/node:16.15'
        steps:
            - prepare-container
            - pre-checks

    # Test_Thread_1:
    #     docker:
    #         - image: 'cimg/node:16.15'
    #     steps:
    #         - prepare
    #         - run_rskj_node
    #         - run:
    #               name: Tests Thread 1
    #               command: |
    #                   source "scripts/utils.sh"
    #                   run_test_suite_on_ci $TEST_SUITE_1

    Test_Thread_2:
        docker:
            - image: 'cimg/node:16.15'
        steps:
            - prepare
            - run_rskj_node
            - run:
                  name: Tests Thread 2
                  command: |
                      source "scripts/utils.sh"
                      run_test_suite_on_ci $TEST_SUITE_2

    # Test_Thread_3:
    #     docker:
    #         - image: 'cimg/node:16.15'
    #     steps:
    #         - prepare
    #         - run_rskj_node
    #         - run:
    #               name: Tests Thread 3
    #               command: |
    #                   source "scripts/utils.sh"
    #                   run_test_suite_on_ci $TEST_SUITE_3

    # Test_Thread_4:
    #     docker:
    #         - image: 'cimg/node:16.15'
    #     steps:
    #         - prepare
    #         - run_rskj_node
    #         - run:
    #               name: Tests Thread 4
    #               command: |
    #                   source "scripts/utils.sh"
    #                   run_test_suite_on_ci $TEST_SUITE_4

    # Test_Thread_5:
    #     docker:
    #         - image: 'cimg/node:16.15'
    #     steps:
    #         - prepare
    #         - run_rskj_node
    #         - run:
    #               name: Tests Thread 5
    #               command: |
    #                   source "scripts/utils.sh"
    #                   run_test_suite_on_ci $TEST_SUITE_5

workflows:
    commit:
        jobs:
            - CodeStyle Checks
            - Test_Thread_2
            # - Test_Thread_3
            # - Test_Thread_4
            # - Test_Thread_5
